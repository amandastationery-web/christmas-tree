<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gesture Christmas Tree</title>

<style>
html,body{
  margin:0;overflow:hidden;
  background:#000;color:#d4af37;
}
#video{
  position:fixed;left:10px;bottom:10px;
  width:120px;border:1px solid #333;opacity:.7
}
#tip{
  position:fixed;top:10px;left:10px;
  font-size:12px
}
</style>
</head>

<body>
<div id="tip">âœ‹æ—‹è½¬ âœŠèšåˆ ğŸ¤æ‹‰è¿‘</div>
<video id="video" autoplay playsinline></video>

<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ---------- Three.js ---------- */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,50);
camera.position.z=8;

const renderer=new THREE.WebGLRenderer({powerPreference:"low-power"});
renderer.setPixelRatio(1);
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffd700,1));

/* åœ£è¯æ ‘ç²’å­ */
const geo=new THREE.BufferGeometry();
const target=[],spread=[];
for(let i=0;i<400;i++){
  const h=Math.random()*4;
  const r=(4-h)*Math.random()*0.4;
  const a=Math.random()*Math.PI*2;
  target.push(Math.cos(a)*r,h-2,Math.sin(a)*r);
  spread.push((Math.random()-0.5)*6,(Math.random()-0.5)*6,(Math.random()-0.5)*6);
}
const pos=new Float32Array(spread);
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));

const mat=new THREE.PointsMaterial({color:0xd4af37,size:0.06});
const tree=new THREE.Points(geo,mat);
scene.add(tree);

let gather=0;

/* ---------- MediaPipe ---------- */
const video=document.getElementById("video");

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:0,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
});

hands.onResults(res=>{
  if(!res.multiHandLandmarks) return;
  const lm=res.multiHandLandmarks[0];

  const thumb=lm[4], index=lm[8];
  const pinch=Math.hypot(thumb.x-index.x,thumb.y-index.y);

  const open = lm[8].y < lm[6].y && lm[12].y < lm[10].y;
  const fist = lm[8].y > lm[6].y && lm[12].y > lm[10].y;

  if(open) tree.rotation.y+=0.02;
  if(fist) gather=Math.min(1,gather+0.05);
  else gather=Math.max(0,gather-0.05);

  if(pinch<0.05) camera.position.z=Math.max(4,camera.position.z-0.2);
  else camera.position.z=Math.min(8,camera.position.z+0.05);
});

/* æ‘„åƒå¤´ */
new Camera(video,{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480
}).start();

/* ---------- åŠ¨ç”» ---------- */
function animate(){
  requestAnimationFrame(animate);
  const p=geo.attributes.position.array;
  for(let i=0;i<p.length;i++){
    p[i]=spread[i]*(1-gather)+target[i]*gather;
  }
  geo.attributes.position.needsUpdate=true;
  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
